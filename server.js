const webpush = require('web-push');

// Configuration des clÃ©s de sÃ©curitÃ© (VAPID)
// Remplace par tes propres clÃ©s si tu en as dÃ©jÃ , sinon celles-ci servent au test
const vapidKeys = {
  publicKey: 'TON_CLE_PUBLIQUE_ICI',
  privateKey: 'TON_CLE_PRIVEE_ICI'
};

webpush.setVapidDetails(
  'mailto:tonemail@exemple.com',
  vapidKeys.publicKey,
  vapidKeys.privateKey
);
// ğŸš€ GENLOVE - SERVEUR.JS V4.4 - AMENDEMENTS 1&2 CONFIG SANTÃ‰ âœ…
// âœ… 1ï¸âƒ£ Supprimer compte = FONCTIONNEL (boutons OK)
// âœ… 2ï¸âƒ£ Config santÃ© = Ã‰DITION + ENREGISTRER/ANNULER FONCTIONNELS âœ…
// âœ… Deploy direct Render Luanda AO - FÃ©vrier 2026

const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
const app = express();
const port = process.env.PORT || 3000;

// ğŸ”’ SÃ‰CURITÃ‰ RENDER
console.log("âœ… Base MongoDB SÃ‰CURISÃ‰E - Vrais utilisateurs prÃ©servÃ©s");

// âœ… CONNEXION MONGODB
const mongoURI = process.env.MONGODB_URI; 
mongoose.connect(mongoURI)
    .then(() => console.log("âœ… ConnectÃ© Ã  MongoDB pour Genlove !"))
    .catch(err => console.error("âŒ Erreur MongoDB:", err));

// âœ… CORS + JSON + STATIC (ORDRE IMPORTANT)
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(express.static('public'));

// âœ… MODÃˆLE UTILISATEUR (avec fallback photo)
const UserSchema = new mongoose.Schema({
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    gender: String,
    dob: String,
    residence: String,
    genotype: String,
    bloodGroup: String,
    desireChild: String,
    photo: { type: String, default: "https://via.placeholder.com/150?text=ğŸ‘¤" },
    createdAt: { type: Date, default: Date.now }
});
const User = mongoose.model('User', UserSchema);

// âœ… META + FAVICON + CSS
const head = `<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90' fill='%23ff416c'>ğŸ’•</text></svg>"><meta name="theme-color" content="#ff416c"><meta name="apple-mobile-web-app-capable" content="yes"><title>Genlove</title>`;

const styles = `<style>body{font-family:'Segoe UI',sans-serif;margin:0;background:#fdf2f2;display:flex;justify-content:center}.app-shell{width:100%;max-width:420px;min-height:100vh;background:#f4e9da;display:flex;flex-direction:column;box-shadow:0 0 20px rgba(0,0,0,0.1);position:relative}#genlove-notify{position:absolute;top:-100px;left:10px;right:10px;background:#1a2a44;color:white;padding:15px;border-radius:12px;display:flex;align-items:center;gap:10px;transition:0.5s cubic-bezier(0.175,0.885,0.32,1.275);z-index:9999;box-shadow:0 4px 15px rgba(0,0,0,0.3);border-left:5px solid #007bff}.show{top:10px}#loader{display:none;position:absolute;inset:0;background:white;z-index:100;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px}.spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #ff416c;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.home-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:30px;text-align:center}.logo-text{font-size:3.5rem;font-weight:bold;margin-bottom:5px}.slogan{font-weight:bold;color:#1a2a44;margin-bottom:40px;font-size:1rem;line-height:1.5}.page-white{background:white;min-height:100vh;padding:25px 20px;box-sizing:border-box;text-align:center}.photo-circle{width:110px;height:110px;border:2px dashed #ff416c;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;position:relative;cursor:pointer;background-size:cover;background-position:center}.input-box{width:100%;padding:14px;border:1px solid #e2e8f0;border-radius:12px;margin-top:10px;font-size:1rem;box-sizing:border-box;background:#f8f9fa;color:#333}.serment-container{margin-top:20px;padding:15px;background:#fff5f7;border-radius:12px;border:1px solid #ffdae0;text-align:left;display:flex;gap:10px;align-items:flex-start}.serment-text{font-size:0.82rem;color:#d63384;line-height:1.4}.btn-pink{background:#ff416c;color:white;padding:18px;border-radius:50px;text-align:center;text-decoration:none;font-weight:bold;display:block;width:85%;margin:20px auto;border:none;cursor:pointer;transition:0.3s}.btn-dark{background:#1a2a44;color:white;padding:18px;border-radius:12px;text-align:center;text-decoration:none;font-weight:bold;display:block;margin:15px;width:auto;box-sizing:border-box}.btn-action{border:none;border-radius:8px;padding:8px 12px;font-size:0.8rem;font-weight:bold;cursor:pointer;transition:0.2s}.btn-details{background:#ff416c;color:white}.btn-contact{background:#1a2a44;color:white;margin-right:5px}#popup-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;padding:20px}.popup-content{background:white;border-radius:20px;width:100%;max-width:380px;padding:25px;position:relative;text-align:left;animation:slideUp 0.3s ease-out}.close-popup{position:absolute;top:15px;right:15px;font-size:1.5rem;cursor:pointer;color:#666}.st-group{background:white;border-radius:15px;margin:0 15px 15px 15px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);text-align:left}.st-item{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid #f8f8f8;color:#333;font-size:0.95rem}.switch{position:relative;display:inline-block;width:45px;height:24px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;inset:0;background-color:#ccc;transition:.4s;border-radius:24px}.slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%}input:checked+.slider{background-color:#007bff}input:checked+.slider:before{transform:translateX(21px)}.match-card{background:white;margin:10px 15px;padding:15px;border-radius:15px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}.match-photo-blur{width:55px;height:55px;border-radius:50%;background:#eee;filter:blur(6px);background-size:cover;background-position:center}.end-overlay{position:fixed;inset:0;background:linear-gradient(180deg,#4a76b8 0%,#1a2a44 100%);z-index:9999;display:flex;align-items:center;justify-content:center}.end-card{background:white;border-radius:30px;padding:40px 25px;width:85%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2)}@keyframes slideUp{from{transform:translateY(50px);opacity:0}to{transform:translateY(0);opacity:1}}</style>`;

const notifyScript = `<script>function showNotify(msg){const n=document.getElementById('genlove-notify'),m=document.getElementById('notify-msg');if(m)m.innerText=msg;if(n){n.classList.add('show');setTimeout(()=>{n.classList.remove('show')},3500);}}</script>`;

// âœ… FONCTION Ã‚GE (globale)
function calculerAge(dateNaissance){if(!dateNaissance)return"???";const today=new Date(),birthDate=new Date(dateNaissance);let age=today.getFullYear()-birthDate.getFullYear();const monthDiff=today.getMonth()-birthDate.getMonth();if(monthDiff<0||(monthDiff===0&&today.getDate()<birthDate.getDate()))age--;return age;}

// âœ… ROUTE SUPPRESSION COMPTE - FONCTIONNELLE âœ…
app.delete('/api/delete-account/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const deletedUser = await User.findByIdAndDelete(id);
        if (!deletedUser) {
            return res.status(404).json({ error: "Utilisateur non trouvÃ©" });
        }
        console.log("ğŸ—‘ï¸ COMPTE SUPPRIMÃ‰:", deletedUser.firstName);
        res.json({ success: true, message: "Compte supprimÃ© dÃ©finitivement" });
    } catch (error) {
        console.error("âŒ Erreur suppression:", error);
        res.status(500).json({ error: "Erreur serveur" });
    }
});

// âœ… ROUTE UPDATE COMPTE - FONCTIONNELLE âœ…
app.put('/api/update-account/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const updates = req.body;
        const updatedUser = await User.findByIdAndUpdate(id, updates, { new: true });
        if (!updatedUser) {
            return res.status(404).json({ error: "Utilisateur non trouvÃ©" });
        }
        console.log("âœï¸ MODIFIÃ‰:", updatedUser.firstName, updates);
        res.json({ success: true, user: updatedUser });
    } catch (error) {
        console.error("âŒ Erreur update:", error);
        res.status(500).json({ error: "Erreur serveur" });
    }
});

// âœ… ROUTES
app.get('/',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body><div class="app-shell"><div class="home-screen"><div class="logo-text"><span style="color:#1a2a44;">Gen</span><span style="color:#ff416c;">love</span></div><div class="slogan">Unissez cÅ“ur et santÃ© pour bÃ¢tir des couples sains</div><div style="width:100%;margin-top:20px;"><p style="font-size:0.9rem;color:#1a2a44;margin-bottom:10px;">Avez-vous dÃ©jÃ  un compte ?</p><a href="/profile" class="btn-dark">â” Se connecter</a><a href="/charte-engagement" style="color:#1a2a44;text-decoration:none;font-weight:bold;display:block;margin-top:15px;">ğŸ‘¤ CrÃ©er un compte</a></div><div style="font-size:0.75rem;color:#666;margin-top:25px;">ğŸ”’ Vos donnÃ©es sont cryptÃ©es et confidentielles.</div></div></div></body></html>`)});

app.get('/charte-engagement',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body style="background:#fdf2f2;"><div class="app-shell"><div class="page-white" style="display:flex;flex-direction:column;justify-content:center;padding:30px;min-height:100vh;"><div style="font-size:3.5rem;margin-bottom:10px;">ğŸ›¡ï¸</div><h2 style="color:#1a2a44;margin-top:0;">Engagement Ã‰thique</h2><p style="color:#666;font-size:0.9rem;margin-bottom:20px;">Pour protÃ©ger la santÃ© de votre future famille.</p><div id="charte-box" style="height:220px;overflow-y:scroll;background:#fff5f7;border:2px solid #ffdae0;border-radius:15px;padding:20px;font-size:0.85rem;color:#444;line-height:1.6;text-align:left;" onscroll="checkScroll(this)"><b style="color:#ff416c;">1. SincÃ©ritÃ©</b><br>DonnÃ©es mÃ©dicales conformes aux examens.<br><br><b style="color:#ff416c;">2. ResponsabilitÃ©</b><br>Vous garantissez l'authenticitÃ© de votre profil.<br><br><b style="color:#ff416c;">3. ConfidentialitÃ©</b><br>Ã‰changes Ã©phÃ©mÃ¨res (30min max).<br><br><b style="color:#ff416c;">4. SÃ©rÃ©nitÃ©</b><br>Algorithmes protÃ¨gent la santÃ© des enfants.<br><br><b style="color:#ff416c;">5. Respect</b><br>Non-stigmatisation obligatoire.<br><hr style="border:0;border-top:1px solid #ffdae0;margin:15px 0;"><center><i style="color:#ff416c;">Scrollez jusqu'en bas...</i></center></div><button id="agree-btn" onclick="location.href='/signup'" class="btn-pink" style="background:#ccc;cursor:not-allowed;margin-top:25px;width:100%;border:none;" disabled>J'ai lu et je m'engage</button><a href="/" style="margin-top:15px;color:#666;text-decoration:none;font-size:0.8rem;">Annuler</a></div></div></div><script>function checkScroll(el){if(el.scrollHeight-el.scrollTop<=el.clientHeight+5){const btn=document.getElementById('agree-btn');btn.disabled=false;btn.style.background='#ff416c';btn.style.cursor='pointer';el.style.borderColor='#4CAF50';}}</script></body></html>`)});

app.get('/signup',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body><div class="app-shell"><div id="loader"><div class="spinner"></div><h3>Analyse sÃ©curisÃ©e...</h3><p>VÃ©rification donnÃ©es mÃ©dicales.</p></div><div class="page-white" id="main-content"><h2 style="color:#ff416c;margin-top:0;">Configuration SantÃ©</h2><form onsubmit="saveAndRedirect(event)"><div class="photo-circle" id="c" onclick="document.getElementById('i').click()"><span id="t">ğŸ“¸ Photo</span></div><input type="file" id="i" style="display:none" onchange="preview(event)"><input type="text" id="fn" class="input-box" placeholder="PrÃ©nom" required><input type="text" id="ln" class="input-box" placeholder="Nom" required><select id="gender" class="input-box"><option value="">Genre</option><option value="Homme">Homme</option><option value="Femme">Femme</option></select><div style="text-align:left;margin-top:10px;padding-left:5px;"><small style="color:#666;font-size:0.75rem;">ğŸ“… Date de naissance :</small></div><input type="date" id="dob" class="input-box" style="margin-top:2px;"><input type="text" id="res" class="input-box" placeholder="RÃ©sidence"><select id="gt" class="input-box"><option value="">GÃ©notype</option><option>AA</option><option>AS</option><option>SS</option></select><div style="display:flex;gap:10px;"><select id="gs_type" class="input-box" style="flex:2;"><option value="">Groupe</option><option>A</option><option>B</option><option>AB</option><option>O</option></select><select id="gs_rh" class="input-box" style="flex:1;"><option>+</option><option>-</option></select></div><select id="pj" class="input-box"><option value="">DÃ©sir d'enfant ?</option><option>Oui</option><option>Non</option></select><div class="serment-container"><input type="checkbox" id="oath" style="width:20px;height:20px;" required><label for="oath" class="serment-text">Je confirme mon engagement Ã©thique.</label></div><button type="submit" class="btn-pink">ğŸš€ Valider profil</button></form></div></div><script>let b64=localStorage.getItem('current_user_photo')||"";window.onload=()=>{if(b64){document.getElementById('c').style.backgroundImage='url('+b64+')';document.getElementById('t').style.display='none';}};function preview(e){const r=new FileReader();r.onload=()=>{b64=r.result;document.getElementById('c').style.backgroundImage='url('+b64+')';document.getElementById('t').style.display='none';};r.readAsDataURL(e.target.files[0]);}async function saveAndRedirect(e){e.preventDefault();document.getElementById('loader').style.display='flex';const userData={firstName:document.getElementById('fn').value,lastName:document.getElementById('ln').value,gender:document.getElementById('gender').value,dob:document.getElementById('dob').value,residence:document.getElementById('res').value,genotype:document.getElementById('gt').value,bloodGroup:document.getElementById('gs_type').value?(document.getElementById('gs_type').value+document.getElementById('gs_rh').value):"",desireChild:document.getElementById('pj').value,photo:b64||"https://via.placeholder.com/150?text=ğŸ‘¤"};try{const response=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(userData)});const result=await response.json();localStorage.setItem('current_user_data',JSON.stringify(userData));localStorage.setItem('current_user_photo',userData.photo);localStorage.setItem('current_user_id', result.user);if(response.ok){setTimeout(()=>{window.location.href='/profile';},800);}else{throw new Error(result.error||'Erreur serveur');}}catch(err){document.getElementById('loader').style.display='none';alert('âŒ Erreur: '+err.message);}}</script></body></html>`)});

// âœ… API REGISTER CORRIGÃ‰E
app.post('/api/register',async(req,res)=>{try{console.log("ğŸ“¥ INSCRIPTION:",req.body);const{firstName,lastName,gender,dob,residence,genotype,bloodGroup,desireChild,photo}=req.body;if(!firstName||!lastName||!genotype){return res.status(400).json({error:"PrÃ©nom, Nom et GÃ©notype obligatoires"});}const newUser=new User({firstName,lastName,gender,dob,residence,genotype,bloodGroup,desireChild,photo:photo||"https://via.placeholder.com/150?text=ğŸ‘¤"});await newUser.save();console.log("âœ… SAVEGARDÃ‰:",firstName);res.json({success:true,user:newUser._id});}catch(e){console.error("âŒ ERREUR:",e);res.status(500).json({error:e.message});}});

// âœ… PROFIL V4.4 (IDENTIQUE)
app.get('/profile',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body style="background:#f8f9fa;"><div class="app-shell"><div id="genlove-notify"><span>ğŸ’™</span><span id="notify-msg"></span></div><div style="background:white;padding:30px 20px;text-align:center;border-radius:0 0 30px 30px;"><div style="display:flex;justify-content:space-between;align-items:center;"><a href="/" style="text-decoration:none;background:#eff6ff;color:#1a2a44;padding:8px 14px;border-radius:12px;font-size:0.8rem;font-weight:bold;display:flex;align-items:center;gap:8px;border:1px solid #dbeafe;">ğŸ  Accueil</a><a href="/settings" style="text-decoration:none;font-size:1.4rem;">âš™ï¸</a></div><div id="vP" style="width:110px;height:110px;border-radius:50%;border:3px solid #ff416c;margin:20px auto;background-size:cover;background-color:#eee;"></div><h2 id="vN">Chargement...</h2><p id="vR" style="color:#666;margin:0 0 10px 0;font-size:0.9rem;">ğŸ“ Chargement...</p><p style="color:#007bff;font-weight:bold;margin:0;">Profil SantÃ© ValidÃ© âœ…</p></div><div style="padding:15px 20px 5px 20px;font-size:0.75rem;color:#888;font-weight:bold;">MES INFORMATIONS</div><div class="st-group"><div class="st-item"><span>GÃ©notype</span><b id="rG">Chargement...</b></div><div class="st-item"><span>Groupe Sanguin</span><b id="rS">Chargement...</b></div><div class="st-item"><span>Ã‚ge</span><b id="rAge">Chargement...</b></div><div class="st-item"><span>RÃ©sidence</span><b id="rRes">Chargement...</b></div><div class="st-item"><span>Projet (Enfant)</span><b id="rP">Chargement...</b></div></div><a href="/matching" class="btn-dark" style="text-decoration:none;">ğŸ” Trouver un partenaire</a></div><script>function showNotify(msg){const n=document.getElementById('genlove-notify'),m=document.getElementById('notify-msg');if(m)m.innerText=msg;if(n){n.classList.add('show');setTimeout(()=>{n.classList.remove('show')},3500);}}function calculerAge(dateNaissance){if(!dateNaissance)return"???";const today=new Date(),birthDate=new Date(dateNaissance);let age=today.getFullYear()-birthDate.getFullYear();const monthDiff=today.getMonth()-birthDate.getMonth();if(monthDiff<0||(monthDiff===0&&today.getDate()<birthDate.getDate()))age--;return age;}window.onload=function(){try{let userData={},photo='https://via.placeholder.com/150?text=ğŸ‘¤';const stored=localStorage.getItem('current_user_data');if(!stored){showNotify('ğŸ‘¤ Redirection crÃ©ation profil...');setTimeout(()=>{window.location.href='/signup';},1000);return;}userData=JSON.parse(stored);photo=localStorage.getItem('current_user_photo')||photo;const userId=localStorage.getItem('current_user_id');if(!userData.firstName||!userData.genotype){showNotify('ğŸ‘¤ Redirection crÃ©ation profil...');setTimeout(()=>{window.location.href='/signup';},1000);return;}document.getElementById('vP').style.backgroundImage='url('+photo+')';document.getElementById('vN').innerText=userData.firstName+' '+userData.lastName;document.getElementById('vR').innerText='ğŸ“ '+(userData.residence||'Luanda');document.getElementById('rG').innerText=userData.genotype||'Non renseignÃ©';document.getElementById('rS').innerText=userData.bloodGroup||'Non renseignÃ©';document.getElementById('rAge').innerText=userData.dob?calculerAge(userData.dob)+' ans':'Non renseignÃ©';document.getElementById('rRes').innerText=userData.residence||'Luanda';document.getElementById('rP').innerText=userData.desireChild==='Oui'?'Oui':'Non';if(userId)localStorage.setItem('current_user_id',userId);showNotify('âœ… Profil chargÃ© !');}catch(e){console.error('Profil error:',e);showNotify('âŒ Erreur chargement');localStorage.removeItem('current_user_data');localStorage.removeItem('current_user_photo');setTimeout(()=>{window.location.href='/signup';},1500);}}</script>${notifyScript}</body></html>`)});

// âœ… ROUTE CONFIG SANTÃ‰ - NOUVELLE V4.4 âœ…
app.get('/health-config',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body><div class="app-shell"><div id="genlove-notify"><span>ğŸ’™</span><span id="notify-msg"></span></div><div id="loader"><div class="spinner"></div><h3>Chargement config santÃ©...</h3></div><div class="page-white" id="main-content" style="display:none;"><h2 style="color:#ff416c;margin-top:0;">âš•ï¸ Configuration SantÃ©</h2><form onsubmit="saveHealthConfig(event)"><input type="text" id="fn" class="input-box" placeholder="PrÃ©nom" required><input type="text" id="ln" class="input-box" placeholder="Nom" required><select id="gender" class="input-box"><option value="">Genre</option><option value="Homme">Homme</option><option value="Femme">Femme</option></select><input type="date" id="dob" class="input-box"><input type="text" id="res" class="input-box" placeholder="RÃ©sidence"><select id="gt" class="input-box"><option value="">GÃ©notype</option><option>AA</option><option>AS</option><option>SS</option></select><div style="display:flex;gap:10px;"><select id="gs_type" class="input-box" style="flex:2;"><option value="">Groupe</option><option>A</option><option>B</option><option>AB</option><option>O</option></select><select id="gs_rh" class="input-box" style="flex:1;"><option>+</option><option>-</option></select></div><select id="pj" class="input-box"><option value="">DÃ©sir d'enfant ?</option><option>Oui</option><option>Non</option></select><div style="display:flex;gap:15px;margin-top:20px;"><button type="submit" class="btn-pink" style="flex:1;">ğŸ’¾ Enregistrer</button><button type="button" onclick="cancelHealthConfig()" class="btn-dark" style="flex:1;">âŒ Annuler</button></div></form></div></div><script>let userId="";window.onload=()=>{try{const userDataStr=localStorage.getItem('current_user_data');if(!userDataStr){showNotify('ğŸ‘¤ Profil requis');setTimeout(()=>{window.location.href='/profile';},1000);return;}const userData=JSON.parse(userDataStr);userId=localStorage.getItem('current_user_id');if(!userId){showNotify('âŒ ID manquant');setTimeout(()=>{window.location.href='/profile';},1000);return;}document.getElementById('fn').value=userData.firstName||"";document.getElementById('ln').value=userData.lastName||"";document.getElementById('gender').value=userData.gender||"";document.getElementById('dob').value=userData.dob||"";document.getElementById('res').value=userData.residence||"";document.getElementById('gt').value=userData.genotype||"";if(userData.bloodGroup){const gs=userData.bloodGroup.match(/([ABO]+)([+-])/);if(gs){document.getElementById('gs_type').value=gs[1];document.getElementById('gs_rh').value=gs[2];}}document.getElementById('pj').value=userData.desireChild||"";document.getElementById('loader').style.display='none';document.getElementById('main-content').style.display='block';showNotify('âœ… Config santÃ© chargÃ©e');}catch(e){console.error('Health config error:',e);showNotify('âŒ Erreur chargement');}};function showNotify(msg){const n=document.getElementById('genlove-notify'),m=document.getElementById('notify-msg');if(m)m.innerText=msg;if(n){n.classList.add('show');setTimeout(()=>{n.classList.remove('show')},3500);}}async function saveHealthConfig(e){e.preventDefault();document.getElementById('loader').style.display='flex';document.getElementById('main-content').style.display='none';const updates={firstName:document.getElementById('fn').value,lastName:document.getElementById('ln').value,gender:document.getElementById('gender').value,dob:document.getElementById('dob').value,residence:document.getElementById('res').value,genotype:document.getElementById('gt').value,bloodGroup:document.getElementById('gs_type').value?(document.getElementById('gs_type').value+document.getElementById('gs_rh').value):"",desireChild:document.getElementById('pj').value};try{const response=await fetch('/api/update-account/'+userId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updates)});const result=await response.json();if(response.ok){localStorage.setItem('current_user_data',JSON.stringify(updates));showNotify('âœ… Config santÃ© enregistrÃ©e !');setTimeout(()=>{window.location.href='/profile';},1200);}else{throw new Error(result.error||'Erreur serveur');}}catch(err){document.getElementById('loader').style.display='none';document.getElementById('main-content').style.display='block';showNotify('âŒ Erreur: '+err.message);}}function cancelHealthConfig(){if(confirm('Annuler les modifications ?')){window.location.href='/profile';}}</script></body></html>`)});

// âœ… MATCHING V4.4 (IDENTIQUE)
app.get('/matching',async(req,res)=>{try{
    const users=await User.find({}).select('firstName lastName gender dob residence genotype bloodGroup desireChild photo _id').limit(50).lean();
    const partnersWithAge=users.filter(u=>u.genotype&&u.gender&&u._id).map(u=>({
        id:u._id.toString().slice(-4),
        fullId: u._id.toString(),
        gt:u.genotype,
        gs:u.bloodGroup,
        pj:u.desireChild==="Oui"?"DÃ©sire fonder une famille":"Sans enfants",
        name:u.firstName+" "+u.lastName.charAt(0)+".",
        dob:u.dob,
        res:u.residence||"Luanda",
        gender:u.gender,
        photo:u.photo
    }));
    
    const matchesHTML=partnersWithAge.map(p=>`<div class="match-card" data-gt="${p.gt}" data-gender="${p.gender}" data-userid="${p.fullId}"><div class="match-photo-blur" style="background-image:url(${p.photo})"></div><div style="flex:1"><b>${p.name} (#${p.id})</b><br><small>${calculerAge(p.dob)} ans â€¢ ${p.res} â€¢ ${p.gt}</small></div><div style="display:flex;"><button class="btn-action btn-contact" onclick="showNotify('Demande envoyÃ©e Ã  ${p.name}')">Contacter</button><button class="btn-action btn-details" onclick='showDetails(${JSON.stringify(p)})'>DÃ©tails</button></div></div>`).join('');
    
    res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body style="background:#f4f7f6;"><div class="app-shell"><div id="genlove-notify"><span>ğŸ’™</span><span id="notify-msg"></span></div><div style="padding:20px;background:white;text-align:center;border-bottom:1px solid #eee;"><h3 style="margin:0;color:#1a2a44;">Partenaires Compatibles (${partnersWithAge.length})</h3></div><div id="match-container">${matchesHTML||'<p style="text-align:center;color:#666;padding:40px;">Aucun partenaire compatible.<br>Revenez bientÃ´t !</p>'}</div><a href="/profile" class="btn-pink">Retour profil</a></div><div id="popup-overlay" onclick="closePopup()"><div class="popup-content" onclick="event.stopPropagation()"><span class="close-popup" onclick="closePopup()">&times;</span><h3 id="pop-name" style="color:#ff416c;margin-top:0;">DÃ©tails</h3><div id="pop-details" style="font-size:0.95rem;color:#333;line-height:1.6;"></div><div id="pop-msg" style="background:#e7f3ff;padding:15px;border-radius:12px;border-left:5px solid #007bff;font-size:0.85rem;color:#1a2a44;line-height:1.4;margin-top:15px;"></div><button id="pop-btn" class="btn-pink" style="margin:20px 0 0 0;width:100%">ğŸš€ Contacter</button></div></div>${notifyScript}<script>function calculerAge(dateNaissance){if(!dateNaissance)return"???";const today=new Date(),birthDate=new Date(dateNaissance);let age=today.getFullYear()-birthDate.getFullYear();const monthDiff=today.getMonth()-birthDate.getMonth();if(monthDiff<0||(monthDiff===0&&today.getDate()<birthDate.getDate()))age--;return age;}let sP=null;function showDetails(p){sP=p;document.getElementById('pop-name').innerText=p.name+' #'+p.id;document.getElementById('pop-details').innerHTML="<b>Ã‚ge:</b> "+calculerAge(p.dob)+" ans<br><b>RÃ©sidence:</b> "+p.res+"<br><b>GÃ©notype:</b> "+p.gt+"<br><b>Groupe:</b> "+p.gs+"<br><br><b>Projet:</b><br><i>"+p.pj+"</i>";document.getElementById('pop-msg').style.display='block';document.getElementById('pop-msg').innerHTML="<b>L'Union SÃ©rÃ©nitÃ©:</b> CompatibilitÃ© validÃ©e.";document.getElementById('pop-btn').innerText="ğŸš€ Contacter";document.getElementById('pop-btn').onclick=()=>{sessionStorage.setItem('chatPartner',JSON.stringify(sP));window.location.href='/chat';};document.getElementById('popup-overlay').style.display='flex';}function closePopup(){document.getElementById('popup-overlay').style.display='none';}window.onload=()=>{try{const myDataStr=localStorage.getItem('current_user_data');if(!myDataStr){showNotify('ğŸ‘¤ Profil requis');setTimeout(()=>{window.location.href='/profile';},1000);return;}const myData=JSON.parse(myDataStr);const myGt=myData.genotype,myGender=myData.gender,myId=localStorage.getItem('current_user_id');if(!myGt){showNotify('ğŸ‘¤ GÃ©notype requis');setTimeout(()=>{window.location.href='/profile';},1000);return;}let totalFiltered=0;document.querySelectorAll('.match-card').forEach(card=>{const pGt=card.dataset.gt,pGender=card.dataset.gender,pUserId=card.dataset.userid;let visible=true;if(pUserId===myId)visible=false;if(myGender&&pGender===myGender)visible=false;if((myGt==='SS'||myGt==='AS')&&pGt!=='AA')visible=false;if(myGt==='SS'&&pGt==='SS')visible=false;if(visible){totalFiltered++;card.style.display='flex';}else{card.style.display='none';}});if((myGt==='SS'||myGt==='AS')&&totalFiltered===0){document.getElementById('pop-name').innerText="Protection SantÃ© â¤ï¸";document.getElementById('pop-details').innerHTML="Genlove vous prÃ©sente <b>exclusivement</b> des partenaires AA pour garantir une descendance sans drÃ©panocytose.";document.getElementById('pop-msg').style.display='none';document.getElementById('pop-btn').innerText="Je comprends";document.getElementById('pop-btn').onclick=closePopup;document.getElementById('popup-overlay').style.display='flex';}}catch(e){console.error('Matching error:',e);showNotify('âŒ Erreur chargement');}}; </script></body></html>`);
}catch(e){console.error("âŒ Matching:",e);res.status(500).send("Erreur chargement");}});

// âœ… SETTINGS V4.4 - BOUTONS SUPPRIMER/ANNULER FONCTIONNELS âœ…
app.get('/settings',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body style="background:#f4f7f6;"><div class="app-shell"><div id="genlove-notify"><span>ğŸ’™</span><span id="notify-msg"></span></div><div style="padding:25px;background:white;text-align:center;"><div style="font-size:2.5rem;font-weight:bold;"><span style="color:#1a2a44;">Gen</span><span style="color:#ff416c;">love</span></div></div><div style="padding:15px 20px 5px 20px;font-size:0.75rem;color:#888;font-weight:bold;">CONFIDENTIALITÃ‰</div><div class="st-group"><div class="st-item"><span>VisibilitÃ© profil</span><label class="switch"><input type="checkbox" checked onchange="showNotify('VisibilitÃ© mise Ã  jour !')"><span class="slider"></span></label></div><div class="st-item"><span>Notifications</span><label class="switch"><input type="checkbox" onchange="showNotify('Notifications '+ (this.checked?'activÃ©es':'dÃ©sactivÃ©es'))"><span class="slider"></span></label></div></div><div class="st-group"><a href="/edit-profile" style="text-decoration:none;" class="st-item"><span>âœï¸ Modifier profil</span><b>Modifier â”</b></a><a href="/health-config" style="text-decoration:none;" class="st-item"><span>âš•ï¸ Config santÃ©</span><b>Modifier â”</b></a></div><div class="st-group"><div class="st-item" style="color:red;font-weight:bold;">ğŸ—‘ï¸ Supprimer compte</div><div style="display:flex;justify-content:space-around;padding:15px;"><button id="delete-btn" onclick="deleteAccount()" style="background:#dc3545;color:white;border:none;padding:12px 25px;border-radius:12px;cursor:pointer;font-weight:bold;font-size:0.9rem;">Supprimer</button><button onclick="cancelDelete()" style="background:#28a745;color:white;border:none;padding:12px 25px;border-radius:12px;cursor:pointer;font-weight:bold;font-size:0.9rem;">Annuler</button></div></div><a href="/profile" class="btn-pink">Retour profil</a></div><script>function showNotify(msg){const n=document.getElementById('genlove-notify'),m=document.getElementById('notify-msg');if(m)m.innerText=msg;if(n){n.classList.add('show');setTimeout(()=>{n.classList.remove('show')},3500);}}async function deleteAccount(){if(confirm('âš ï¸ Supprimer DÃ‰FINITIVEMENT votre compte Genlove ?\
\
Cette action est irrÃ©versible.')){try{const userId=localStorage.getItem('current_user_id');if(!userId){showNotify('âŒ ID utilisateur manquant');return;}document.getElementById('delete-btn').innerText='Suppression...';document.getElementById('delete-btn').disabled=true;const response=await fetch('/api/delete-account/'+userId,{method:'DELETE'});const result=await response.json();if(response.ok){localStorage.clear();showNotify('âœ… Compte supprimÃ© dÃ©finitivement');setTimeout(()=>{location.href='/';},2000);}else{throw new Error(result.error||'Erreur serveur');}}catch(e){console.error('Delete error:',e);showNotify('âŒ Erreur: '+e.message);document.getElementById('delete-btn').innerText='Supprimer';document.getElementById('delete-btn').disabled=false;}}}function cancelDelete(){showNotify('âŒ Annulation - Compte prÃ©servÃ©');}</script>${notifyScript}</body></html>`)});

// âœ… Ã‰DITION PROFIL V4.4 (IDENTIQUE)
app.get('/edit-profile',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body><div class="app-shell"><div id="genlove-notify"><span>ğŸ’™</span><span id="notify-msg"></span></div><div id="loader"><div class="spinner"></div><h3>Chargement profil...</h3></div><div class="page-white" id="main-content" style="display:none;"><h2 style="color:#ff416c;margin-top:0;">âœï¸ Modifier Profil</h2><form onsubmit="updateProfile(event)"><div class="photo-circle" id="c" onclick="document.getElementById('i').click()"><span id="t">ğŸ“¸ Photo</span></div><input type="file" id="i" style="display:none" onchange="preview(event)"><input type="text" id="fn" class="input-box" placeholder="PrÃ©nom" required><input type="text" id="ln" class="input-box" placeholder="Nom" required><select id="gender" class="input-box"><option value="">Genre</option><option value="Homme">Homme</option><option value="Femme">Femme</option></select><div style="text-align:left;margin-top:10px;padding-left:5px;"><small style="color:#666;font-size:0.75rem;">ğŸ“… Date de naissance :</small></div><input type="date" id="dob" class="input-box" style="margin-top:2px;"><input type="text" id="res" class="input-box" placeholder="RÃ©sidence"><select id="gt" class="input-box"><option value="">GÃ©notype</option><option>AA</option><option>AS</option><option>SS</option></select><div style="display:flex;gap:10px;"><select id="gs_type" class="input-box" style="flex:2;"><option value="">Groupe</option><option>A</option><option>B</option><option>AB</option><option>O</option></select><select id="gs_rh" class="input-box" style="flex:1;"><option>+</option><option>-</option></select></div><select id="pj" class="input-box"><option value="">DÃ©sir d'enfant ?</option><option>Oui</option><option>Non</option></select><div class="serment-container"><input type="checkbox" id="oath" style="width:20px;height:20px;" required><label for="oath" class="serment-text">Je confirme les modifications.</label></div><div style="display:flex;gap:15px;margin-top:20px;"><button type="submit" class="btn-pink" style="flex:1;">ğŸ’¾ Enregistrer</button><a href="/settings" class="btn-dark" style="flex:1;text-align:center;line-height:18px;">âŒ Annuler</a></div></form></div></div><script>let b64="",userId="";window.onload=()=>{try{const userDataStr=localStorage.getItem('current_user_data');if(!userDataStr){showNotify('ğŸ‘¤ Profil requis');setTimeout(()=>{window.location.href='/profile';},1000);return;}const userData=JSON.parse(userDataStr);userId=localStorage.getItem('current_user_id');b64=localStorage.getItem('current_user_photo')||"";document.getElementById('fn').value=userData.firstName||"";document.getElementById('ln').value=userData.lastName||"";document.getElementById('gender').value=userData.gender||"";document.getElementById('dob').value=userData.dob||"";document.getElementById('res').value=userData.residence||"";document.getElementById('gt').value=userData.genotype||"";if(userData.bloodGroup){const gs=userData.bloodGroup.match(/([ABO]+)([+-])/);if(gs){document.getElementById('gs_type').value=gs[1];document.getElementById('gs_rh').value=gs[2];}}document.getElementById('pj').value=userData.desireChild||"";if(b64){document.getElementById('c').style.backgroundImage='url('+b64+')';document.getElementById('t').style.display='none';}document.getElementById('loader').style.display='none';document.getElementById('main-content').style.display='block';showNotify('âœ… Profil chargÃ© pour Ã©dition');}catch(e){console.error('Edit load error:',e);showNotify('âŒ Erreur chargement');}};function preview(e){const r=new FileReader();r.onload=()=>{b64=r.result;document.getElementById('c').style.backgroundImage='url('+b64+')';document.getElementById('t').style.display='none';};r.readAsDataURL(e.target.files[0]);}async function updateProfile(e){e.preventDefault();document.getElementById('loader').style.display='flex';document.getElementById('main-content').style.display='none';const updates={firstName:document.getElementById('fn').value,lastName:document.getElementById('ln').value,gender:document.getElementById('gender').value,dob:document.getElementById('dob').value,residence:document.getElementById('res').value,genotype:document.getElementById('gt').value,bloodGroup:document.getElementById('gs_type').value?(document.getElementById('gs_type').value+document.getElementById('gs_rh').value):"",desireChild:document.getElementById('pj').value,photo:b64||localStorage.getItem('current_user_photo')||""};try{const response=await fetch('/api/update-account/'+userId,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(updates)});const result=await response.json();if(response.ok){localStorage.setItem('current_user_data',JSON.stringify(updates));localStorage.setItem('current_user_photo',updates.photo);showNotify('âœ… Profil mis Ã  jour !');setTimeout(()=>{window.location.href='/profile';},1200);}else{throw new Error(result.error||'Erreur serveur');}}catch(err){document.getElementById('loader').style.display='none';document.getElementById('main-content').style.display='block';showNotify('âŒ Erreur: '+err.message);}}function showNotify(msg){const n=document.getElementById('genlove-notify'),m=document.getElementById('notify-msg');if(m)m.innerText=msg;if(n){n.classList.add('show');setTimeout(()=>{n.classList.remove('show')},3500);}}</script>${notifyScript}</body></html>`)});

app.get('/chat',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body><div id="security-popup" style="position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;"><div style="background:white;border-radius:30px;padding:35px 25px;text-align:center;width:88%;"><h3>ğŸ”’ Discussion PrivÃ©e</h3><p><b>Ã‰change sÃ©curisÃ© Genlove.</b></p><div style="background:#f0f7ff;border-radius:15px;padding:15px;text-align:left;margin:20px 0;border:1px solid #d0e3ff;"><div>ğŸ›¡ï¸ <b>Ã‰phÃ©mÃ¨re:</b> 30 min max.</div><div>ğŸ•µï¸ <b>PrivÃ©:</b> Rien conservÃ©.</div></div><button style="background:#4a76b8;color:white;border:none;padding:16px;border-radius:30px;font-weight:bold;cursor:pointer;width:100%;" onclick="this.parentElement.parentElement.style.display='none';startTimer()">DÃ©marrer</button></div></div><div class="app-shell" style="background:#f0f2f5;height:100vh;overflow:hidden;"><div class="chat-header" style="background:#9dbce3;color:white;padding:12px 15px;display:flex;justify-content:space-between;align-items:center;"><button class="btn-quit" onclick="if(confirm('Quitter ?'))location.href='/chat-end'" style="background:#ffffff;color:#9dbce3;border:none;width:32px;height:32px;border-radius:8px;font-size:1.2rem;font-weight:bold;cursor:pointer;">âœ•</button><div class="digital-clock" style="background:#1a1a1a;color:#ff416c;padding:6px 15px;border-radius:10px;font-family:'Courier New',monospace;font-weight:bold;font-size:1.1rem;">â¤ï¸ <span id="timer-display">30:00</span></div><button class="btn-logout-badge" onclick="if(confirm('DÃ©connecter ?'))location.href='/logout-success'" style="background:#1a2a44;color:white;border:none;padding:8px 15px;border-radius:8px;font-size:0.85rem;font-weight:bold;cursor:pointer;">Logout ğŸ”’</button></div><div class="chat-messages" id="box" style="flex:1;padding:15px;background:#f8fafb;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding-bottom:100px;"><div class="bubble received" style="padding:12px 16px;border-radius:18px;max-width:80%;line-height:1.4;background:#e2ecf7;align-self:flex-start;">Bonjour ! Ton profil m'intÃ©resse ğŸ‘‹</div></div><div class="input-area" style="position:fixed;bottom:0;width:100%;max-width:450px;padding:10px 15px 45px 15px;border-top:1px solid #eee;display:flex;gap:10px;background:white;"><textarea id="msg" style="flex:1;background:#f1f3f4;border:none;padding:12px;border-radius:25px;" placeholder="Ã‰crivez ici..."></textarea><button style="background:#4a76b8;color:white;border:none;width:45px;height:45px;border-radius:50%;" onclick="send()">â¤</button></div></div><script>let t=1800;function startTimer(){setInterval(()=>{t--;let m=Math.floor(t/60),s=t%60;document.getElementById('timer-display').innerText=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;if(t<=0){localStorage.clear();window.location.href='/logout-success';}},1000);}function send(){const i=document.getElementById('msg');if(i.value.trim()){const d=document.createElement('div');d.className='bubble sent';d.innerText=i.value;d.style.cssText='padding:12px 16px;border-radius:18px;max-width:80%;line-height:1.4;background:#ff416c;color:white;align-self:flex-end;';document.getElementById('box').appendChild(d);i.value='';document.getElementById('box').scrollTop=document.getElementById('box').scrollHeight;}}</script></body></html>`)});

app.get('/chat-end',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body class="end-overlay"><div class="end-card"><div style="font-size:50px;margin-bottom:10px;">âœ¨</div><h2 style="color:#1a2a44;">Merci pour cet Ã©change</h2><p style="color:#666;margin-bottom:30px;">Genlove vous remercie.</p><a href="/matching" class="btn-pink" style="width:100%;margin:0;">ğŸ” Autre profil</a></div></body></html>`)});

app.get('/logout-success',(req,res)=>{res.send(`<!DOCTYPE html><html><head>${head}${styles}</head><body class="end-overlay"><div class="end-card"><div style="font-size:50px;margin-bottom:20px;">ğŸ›¡ï¸</div><h2 style="color:#1a2a44;">Session fermÃ©e</h2><p style="color:#666;margin-bottom:30px;">SÃ©curitÃ© assurÃ©e.</p><button onclick="location.href='/'" class="btn-dark" style="width:100%;margin:0;border-radius:50px;cursor:pointer;border:none;">Quitter</button></div></body></html>`)});

app.listen(port,'0.0.0.0',()=>{console.log(`ğŸš€ Genlove V4.4 sur port ${port}`);console.log("âœ… V4.4: SUPPRIMER COMPTE + CONFIG SANTÃ‰ FONCTIONNELS âœ“");console.log("âœ… Boutons Enregistrer/Annuler santÃ© + Supprimer/Annuler OK");console.log("âœ… /health-config + PUT/DELETE APIs 100% opÃ©rationnelles");});